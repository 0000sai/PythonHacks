<!DOCTYPE html>
<html>
<head>
  <title>Webcam for Facial Recognition</title>
  <link rel="stylesheet" href="../static/style.css">
</head>
<body>
  <div class="facial-recognition" align="center">
    <br><br>
    <h1>Register Face</h1>
    <br>
    <div class="booth">
      <video id="webcam" width="25%" height="25%" autoplay></video>
      <canvas id="canvas" style="display: none;"></canvas>
    </div>
    <br>
    <img id="result" width="25%" height="25%">
    <br>
    <br>
    <br>
    <!-- Add First Name, Last Name, Date of Birth, and Phone Number fields -->
    <label for="firstName">First Name:</label>
    <input type="text" id="firstName" name="firstName" required="required"><br>
    <br>
    <label for="lastName">Last Name:</label>
    <input type="text" id="lastName" name="lastName" required="required"><br>
    <br>
    <label for="dob">Date of Birth:</label>
    <input type="date" id="dob" name="dob" required="required"><br>
    <br>
    <label for="phoneNumber">Phone Number:</label>
    <input type="number" id="phoneNumber" name="phoneNumber" required="required">
    <br>
    <br>
    <br>
    <!-- End of form elements -->

    <div align="center">
      <button id="startButton" class="btn" align="center">Start Webcam</button>
      <button id="stopButton" class="btn" align="center">Stop Webcam</button>
      <button id="captureButton" class="btn" align="center">Capture Image</button>
      <button id="clearButton" class="btn" align="center">Clear Image</button>
    </div>
    <br>
    <div class="admintask" align="center">
      <li><a href="{{url_for('index')}}">Back</a></li>
    </div>
  </div>
  <script>
    let webcamStream;
    const webcam = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const resultImage = document.getElementById('result');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const captureButton = document.getElementById('captureButton');

    function startWebcam() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          webcamStream = stream;
          webcam.srcObject = webcamStream;
        })
        .catch(error => {
          console.error('Error accessing webcam:', error);
        });
    }

    function stopWebcam() {
      if (webcamStream) {
        const tracks = webcamStream.getTracks();
        tracks.forEach(track => track.stop());
        webcamStream = null;
        webcam.srcObject = null;
      }
    }

    function captureImage() {
      if (!webcamStream) {
        alert("Webcam is not active!");
        return;
      }

      const context = canvas.getContext('2d');
      canvas.width = webcam.videoWidth;
      canvas.height = webcam.videoHeight;
      context.drawImage(webcam, 0, 0, canvas.width, canvas.height);

      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      resultImage.src = convertToColorImage(imageData);

      // Convert color image data to base64 string
      const colorImageBase64 = resultImage.src.replace('data:image/png;base64,', '');

      // Get values from the form elements
      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      const dob = document.getElementById('dob').value;
      const phoneNumber = document.getElementById('phoneNumber').value;

      // Create a FormData object and append the form data
      const formData = new FormData();
      formData.append('colorImageData', colorImageBase64);
      formData.append('firstName', firstName);
      formData.append('lastName', lastName);
      formData.append('dob', dob);
      formData.append('phoneNumber', phoneNumber);

      // Send form data and color image data to Flask function
      fetch('/process_color_image', {
        method: 'POST',
        body: formData,
      })
        .then(response => response.json())
        .then(data => {
          // Handle Flask response if needed
          console.log(data);
          if (data && data.success === true) {
            // Redirect to 'registersuccess.html' on success
            window.location.href = '/registersuccess';
          } else {
            // Redirect to 'registerfail.html' on failure
            window.location.href = '/registerfail';
          }
        })
        .catch(error => {
          console.error('Error sending data to Flask:', error);
          window.location.href = '/registerfail';
        });
    }

    function convertToColorImage(imageData) {
      const colorCanvas = document.createElement('canvas');
      colorCanvas.width = imageData.width;
      colorCanvas.height = imageData.height;
      const context = colorCanvas.getContext('2d');
      context.putImageData(imageData, 0, 0);

      // Return the color image as a data URL
      return colorCanvas.toDataURL();
    }

    function clearImage() {
      resultImage.src = '';
    }

    startButton.addEventListener('click', startWebcam);
    stopButton.addEventListener('click', stopWebcam);
    captureButton.addEventListener('click', captureImage);
    clearButton.addEventListener('click', clearImage);
  </script>
</body>
</html>
